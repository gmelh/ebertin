<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Ebertin.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="using:Ebertin.Converters"
        xmlns:views="using:Ebertin.Views"
        xmlns:controls="using:Ebertin.Controls"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="Ebertin.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="Ebertin"
        Background="#36454F"
        PointerPressed="MainWindow_PointerPressed">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Window.Resources>
        <SolidColorBrush x:Key="MenuFlyoutPresenterBackground" Color="#2C3A42"/>
        <SolidColorBrush x:Key="MenuFlyoutPresenterBorderBrush" Color="#1A2329"/>
        <converters:BooleanToColorConverter x:Key="BooleanToColorConverter"/>
    </Window.Resources>

    <Window.Styles>
        <!-- Style for the Menu bar -->
        <Style Selector="Menu">
            <Setter Property="Background" Value="#2C3A42"/>
        </Style>
        
        <!-- Style for menu items -->
        <Style Selector="MenuItem">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontWeight" Value="Normal"/>
        </Style>
        
        <!-- Style for menu items on hover -->
        <Style Selector="MenuItem:pointerover /template/ ContentPresenter#PART_HeaderPresenter">
            <Setter Property="Background" Value="#3E4C54"/>
            <Setter Property="Foreground" Value="#D0D0D0"/>
        </Style>
        
        <!-- Keep File menu item from turning black when submenu is open -->
        <Style Selector="MenuItem:selected /template/ ContentPresenter#PART_HeaderPresenter">
            <Setter Property="Background" Value="#3E4C54"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <!-- Override the popup background directly -->
        <Style Selector="MenuItem">
            <Style.Resources>
                <SolidColorBrush x:Key="MenuFlyoutPresenterBackground" Color="#2C3A42"/>
                <SolidColorBrush x:Key="MenuFlyoutItemBackground" Color="#2C3A42"/>
                <SolidColorBrush x:Key="MenuFlyoutItemBackgroundPointerOver" Color="#3E4C54"/>
            </Style.Resources>
        </Style>
        
        <!-- Style for modal window -->
        <Style Selector="Button.close-button">
            <Setter Property="Background" Value="#3E4C54"/>
            <Setter Property="BorderBrush" Value="#4A5A64"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Width" Value="100"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        
        <!-- Override TextBox styles completely to fix text color issues -->
        <Style Selector="TextBox">
            <Setter Property="Background" Value="#36454F"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#4A5A64"/>
            <Setter Property="CaretBrush" Value="White"/>
            <Setter Property="SelectionBrush" Value="#3D8BF5"/>
            <Setter Property="SelectionForegroundBrush" Value="White"/>
            <Setter Property="Template">
                <ControlTemplate>
                    <Border Name="PART_BorderElement"
                           Background="{TemplateBinding Background}"
                           BorderBrush="{TemplateBinding BorderBrush}"
                           BorderThickness="{TemplateBinding BorderThickness}"
                           CornerRadius="{TemplateBinding CornerRadius}">
                        <DockPanel Margin="{TemplateBinding Padding}">
                            <TextBlock Name="PART_Watermark"
                                     Text="{TemplateBinding Watermark}"
                                     Foreground="#AAD0D0D0"
                                     IsVisible="{TemplateBinding Text, Converter={x:Static StringConverters.IsNullOrEmpty}}"
                                     VerticalAlignment="Center"/>
                            <ScrollViewer Name="PART_ScrollViewer"
                                        HorizontalScrollBarVisibility="{TemplateBinding (ScrollViewer.HorizontalScrollBarVisibility)}"
                                        VerticalScrollBarVisibility="{TemplateBinding (ScrollViewer.VerticalScrollBarVisibility)}">
                                <Panel>
                                    <TextPresenter Name="PART_TextPresenter"
                                                Text="{TemplateBinding Text, Mode=TwoWay}"
                                                CaretIndex="{TemplateBinding CaretIndex}"
                                                SelectionStart="{TemplateBinding SelectionStart}"
                                                SelectionEnd="{TemplateBinding SelectionEnd}"
                                                TextAlignment="{TemplateBinding TextAlignment}"
                                                TextWrapping="{TemplateBinding TextWrapping}"
                                                PasswordChar="{TemplateBinding PasswordChar}"
                                                RevealPassword="{TemplateBinding RevealPassword}"
                                                SelectionBrush="{TemplateBinding SelectionBrush}"
                                                SelectionForegroundBrush="{TemplateBinding SelectionForegroundBrush}"
                                                CaretBrush="{TemplateBinding CaretBrush}"
                                                Foreground="White"/>
                                </Panel>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                </ControlTemplate>
            </Setter>
        </Style>
        
        <Style Selector="TextBox:pointerover /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="#36454F"/>
            <Setter Property="BorderBrush" Value="#6A7A84"/>
        </Style>
        
        <Style Selector="TextBox:focus /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="#36454F"/>
            <Setter Property="BorderBrush" Value="#6A7A84"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        
        <!-- Fix for button hover styles to maintain white text -->
        <Style Selector="Button:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#4A5A64"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        <Style Selector="Border.message-success">
            <Setter Property="Background" Value="#1A4D4D4D"/>
            <Setter Property="BorderBrush" Value="#336B6B6B"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        
        <Style Selector="Border.message-warning">
            <Setter Property="Background" Value="#1AFFC107"/>
            <Setter Property="BorderBrush" Value="#33FFC107"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        
        <Style Selector="Border.message-error">
            <Setter Property="Background" Value="#1AFF5252"/>
            <Setter Property="BorderBrush" Value="#33FF5252"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        
        <Style Selector="Border.message-success TextBlock">
            <Setter Property="Foreground" Value="#228B22"/>
        </Style>
        
        <Style Selector="Border.message-warning TextBlock">
            <Setter Property="Foreground" Value="#856404"/>
        </Style>
        
        <Style Selector="Border.message-error TextBlock">
            <Setter Property="Foreground" Value="#FFFFFF"/>
        </Style>
    </Window.Styles>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
            </MenuItem>
            <MenuItem Header="_Settings">
                <MenuItem Header="_API Keys" Command="{Binding OpenApiKeyWindowCommand}"/>
            </MenuItem>
        </Menu>
        
        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Background="#2C3A42" Padding="0,8">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="71,0,0,0">
                <Grid Margin="0,0,5,0">
                    <Button Width="50" Height="50" Command="{Binding Button1Command}"
                            ToolTip.Tip="Single Dial">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Single circle icon -->
                                <Ellipse Canvas.Left="10" Canvas.Top="10" Width="80" Height="80" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                    <Border Height="3" VerticalAlignment="Bottom" 
                            Background="{Binding IsTopButton1Active, Converter={StaticResource BooleanToColorConverter}}" />
                </Grid>
                <Grid Margin="0,0,5,0">
                    <Button Width="50" Height="50" Command="{Binding Button2Command}"
                            ToolTip.Tip="Bi-Dial">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Circle within a circle icon - with inner circle closer to outer -->
                                <Ellipse Canvas.Left="10" Canvas.Top="10" Width="80" Height="80" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Ellipse Canvas.Left="20" Canvas.Top="20" Width="60" Height="60" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                    <Border Height="3" VerticalAlignment="Bottom" 
                            Background="{Binding IsTopButton2Active, Converter={StaticResource BooleanToColorConverter}}" />
                </Grid>
                <Grid>
                    <Button Width="50" Height="50" Command="{Binding Button3Command}"
                            ToolTip.Tip="Tri-Dial">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Three concentric circles with consistent spacing -->
                                <Ellipse Canvas.Left="10" Canvas.Top="10" Width="80" Height="80" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Ellipse Canvas.Left="20" Canvas.Top="20" Width="60" Height="60" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Ellipse Canvas.Left="30" Canvas.Top="30" Width="40" Height="40" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                    <Border Height="3" VerticalAlignment="Bottom" 
                            Background="{Binding IsTopButton3Active, Converter={StaticResource BooleanToColorConverter}}" />
                </Grid>
            </StackPanel>
        </Border>
        
        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="#2C3A42" Padding="10,5">
            <TextBlock Text="Ready" 
                       Foreground="White" 
                       VerticalAlignment="Center"/>
        </Border>
        
        <!-- Left Vertical Menu -->
        <Border DockPanel.Dock="Left" Background="#2C3A42" Padding="5,3,5,5">
            <StackPanel Orientation="Vertical">
                <Grid Margin="0,0,0,5">
                    <Border Width="3" HorizontalAlignment="Left" 
                            Background="{Binding IsFlyoutOpen, Converter={StaticResource BooleanToColorConverter}}" />
                    <Button Width="50" Height="50" Margin="6,0,0,0" 
                            Command="{Binding LeftButton1Command}"
                            ToolTip.Tip="Chart Data">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Left menu button 1 - Hamburger menu -->
                                <Rectangle Canvas.Left="25" Canvas.Top="25" Width="50" Height="10" 
                                           Fill="White" RadiusX="2" RadiusY="2"/>
                                <Rectangle Canvas.Left="25" Canvas.Top="45" Width="50" Height="10" 
                                           Fill="White" RadiusX="2" RadiusY="2"/>
                                <Rectangle Canvas.Left="25" Canvas.Top="65" Width="50" Height="10" 
                                           Fill="White" RadiusX="2" RadiusY="2"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                </Grid>
                <Grid Margin="0,0,0,5">
                    <Border Width="3" HorizontalAlignment="Left" 
                            Background="{Binding IsButton2Active, Converter={StaticResource BooleanToColorConverter}}" />
                    <Button Width="50" Height="50" Margin="6,0,0,0" 
                            Command="{Binding LeftButton2Command}">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Left menu button 2 - Settings icon -->
                                <Ellipse Canvas.Left="35" Canvas.Top="35" Width="30" Height="30" 
                                         Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Path Data="M50,20 L50,30 M50,70 L50,80 M20,50 L30,50 M70,50 L80,50 M29,29 L36,36 M64,36 L71,29 M29,71 L36,64 M64,64 L71,71"
                                      Stroke="White" StrokeThickness="5" StrokeLineCap="Round"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                </Grid>
                <Grid>
                    <Border Width="3" HorizontalAlignment="Left" 
                            Background="{Binding IsButton3Active, Converter={StaticResource BooleanToColorConverter}}" />
                    <Button Width="50" Height="50" Margin="6,0,0,0" 
                            Command="{Binding LeftButton3Command}">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#3E4C54"/>
                                <Setter Property="BorderBrush" Value="#4A5A64"/>
                            </Style>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#4A5A64"/>
                            </Style>
                        </Button.Styles>
                        <Viewbox Stretch="Uniform">
                            <Canvas Width="100" Height="100">
                                <!-- Left menu button 3 - Nested square icon -->
                                <Rectangle Canvas.Left="25" Canvas.Top="25" Width="50" Height="50" 
                                           Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Rectangle Canvas.Left="35" Canvas.Top="35" Width="30" Height="30" 
                                           Stroke="White" StrokeThickness="3" Fill="Transparent"/>
                                <Ellipse Canvas.Left="45" Canvas.Top="45" Width="10" Height="10" Fill="White"/>
                            </Canvas>
                        </Viewbox>
                    </Button>
                </Grid>
            </StackPanel>
        </Border>
        
        <!-- Right Panel -->
        <Border DockPanel.Dock="Right" Width="15" Background="#2C3A42" />
        
        <!-- Main Content Area with Flyout Overlay -->
        <Grid>
            <!-- Main Content - Will be under the flyout -->
            <ContentControl Content="{Binding CurrentCanvas}" 
                            PointerReleased="Canvas_PointerReleased"/>
            
            
            <!-- Flyout Panel - Overlays content -->
<!-- Flyout Panel - Overlays content -->
            <Border HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="#2C3A42" 
                    Width="{Binding FlyoutWidth}"
                    ClipToBounds="True"
                    ZIndex="1">
                <Border.Transitions>
                    <Transitions>
                        <DoubleTransition Property="Width" Duration="0:0:0.3" Easing="CubicEaseOut"/>
                    </Transitions>
                </Border.Transitions>
                <Grid Width="425">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <TextBlock Grid.Row="0"
                               Text="Chart Data Entry" 
                               Foreground="White" 
                               FontSize="18"
                               FontWeight="SemiBold"
                               Margin="30,20,30,20"
                               HorizontalAlignment="Left"/>
                    
                    <!-- Content Area with Form Fields -->
                    <StackPanel Grid.Row="1" 
                                Margin="30,0,30,0"
                                Spacing="20"
                                HorizontalAlignment="Left">
                        
                        <!-- Name Field -->
                        <StackPanel Width="365">
                            <TextBlock Text="Name" 
                                       Foreground="White" 
                                       Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Name}"
                                     Watermark="Enter your full name"
                                     Height="35"
                                     Padding="8,0"
                                     FontSize="14"
                                     VerticalContentAlignment="Center">
                                <TextBox.Styles>
                                    <Style Selector="TextBox">
                                        <Setter Property="Background" Value="#3E4C54"/>
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="BorderBrush" Value="#4A5A64"/>
                                    </Style>
                                    <Style Selector="TextBox:focus /template/ Border">
                                        <Setter Property="BorderBrush" Value="#6A7A84"/>
                                    </Style>
                                    <Style Selector="TextBox /template/ TextPresenter#PART_TextPresenter">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                    </Style>
                                    <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                    </Style>
                                </TextBox.Styles>
                            </TextBox>
                        </StackPanel>
                        
                        <!-- Date and Time of Birth Field -->
                        <StackPanel Width="365">
                            <TextBlock Text="Date and Time of Birth" 
                                       Foreground="White" 
                                       Margin="0,0,0,5"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="3*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="2*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Date TextBox -->
                                <TextBox Grid.Column="0"
                                         Text="{Binding BirthDateText}"
                                         Height="35"
                                         Watermark="DD MMM YYYY"
                                         Padding="8,0"
                                         FontSize="14"
                                         VerticalContentAlignment="Center"
                                         Margin="0,0,5,0">
                                    <TextBox.Styles>
                                        <Style Selector="TextBox">
                                            <Setter Property="Background" Value="#3E4C54"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="BorderBrush" Value="#4A5A64"/>
                                        </Style>
                                        <Style Selector="TextBox:focus /template/ Border">
                                            <Setter Property="BorderBrush" Value="#6A7A84"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextPresenter#PART_TextPresenter">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </TextBox.Styles>
                                </TextBox>
                                
                                <TextBlock Grid.Column="1" 
                                           Text="at" 
                                           VerticalAlignment="Center"
                                           Foreground="White"
                                           Margin="5,0"/>
                                
                                <!-- Time TextBox -->
                                <TextBox Grid.Column="2"
                                         Text="{Binding BirthTimeText}"
                                         Height="35"
                                         Watermark="HH:MM"
                                         Padding="8,0"
                                         FontSize="14"
                                         VerticalContentAlignment="Center"
                                         Margin="5,0,0,0">
                                    <TextBox.Styles>
                                        <Style Selector="TextBox">
                                            <Setter Property="Background" Value="#3E4C54"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="BorderBrush" Value="#4A5A64"/>
                                        </Style>
                                        <Style Selector="TextBox:focus /template/ Border">
                                            <Setter Property="BorderBrush" Value="#6A7A84"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextPresenter#PART_TextPresenter">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </TextBox.Styles>
                                </TextBox>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Location of Birth Field with Autocomplete -->
                        <StackPanel Width="365">
                            <TextBlock Text="Location of Birth" 
                                       Foreground="White" 
                                       Margin="0,0,0,5"/>
                            <Grid>
                                <TextBox Name="LocationTextBox"
                                         Text="{Binding LocationSearchText, Mode=TwoWay}"
                                         Watermark="Enter city and country"
                                         Height="35"
                                         Padding="8,0"
                                         FontSize="14"
                                         VerticalContentAlignment="Center"
                                         TextChanged="LocationTextBox_TextChanged"
                                         LostFocus="LocationTextBox_LostFocus">
                                    <TextBox.Styles>
                                        <Style Selector="TextBox">
                                            <Setter Property="Background" Value="#3E4C54"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="BorderBrush" Value="#4A5A64"/>
                                        </Style>
                                        <Style Selector="TextBox:focus /template/ Border">
                                            <Setter Property="BorderBrush" Value="#6A7A84"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextPresenter#PART_TextPresenter">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                        <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </TextBox.Styles>
                                </TextBox>
                                
                                <!-- Autocomplete Popup -->
                                <Popup IsOpen="{Binding IsSuggestionsVisible}"
                                       PlacementTarget="{Binding #LocationTextBox}"
                                       VerticalOffset="5"
                                       Width="{Binding #LocationTextBox.Bounds.Width}">
                                    <Border Background="#3E4C54"
                                            BorderBrush="#4A5A64"
                                            BorderThickness="1">
                                        <ListBox ItemsSource="{Binding LocationSuggestions}"
                                                 Background="Transparent"
                                                 Foreground="White"
                                                 MaxHeight="200"
                                                 SelectionMode="Single"
                                                 SelectionChanged="LocationSuggestion_Selected">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}"
                                                               Foreground="White" 
                                                               Padding="5"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                            <ListBox.Styles>
                                                <Style Selector="ListBoxItem">
                                                    <Setter Property="Padding" Value="8,5"/>
                                                </Style>
                                                <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                                                    <Setter Property="Background" Value="#4A5A64"/>
                                                </Style>
                                                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                                                    <Setter Property="Background" Value="#5A6A74"/>
                                                </Style>
                                            </ListBox.Styles>
                                        </ListBox>
                                    </Border>
                                </Popup>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Submit Button -->
                        <Button Content="Calculate" 
                                Width="140" 
                                Height="35"
                                HorizontalAlignment="Right"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                Margin="0,20,0,0"
                                Command="{Binding SubmitChartDataCommand}">
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="Background" Value="#2B5CE6"/>
                                    <Setter Property="BorderBrush" Value="#1E4EC8"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Style>
                                <Style Selector="Button:pointerover /template/ ContentPresenter">
                                    <Setter Property="Background" Value="#3D6EF7"/>
                                </Style>
                            </Button.Styles>
                        </Button>
                    </StackPanel>
                    
                    <!-- Footer with Close Button -->
                    <Grid Grid.Row="2" 
                          Margin="30,20,30,20">
                        <Button Content="Close" 
                                Width="100" 
                                Height="30"
                                HorizontalAlignment="Right"
                                HorizontalContentAlignment="Center"
                                Command="{Binding CloseFlyoutCommand}">
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="Background" Value="#3E4C54"/>
                                    <Setter Property="BorderBrush" Value="#4A5A64"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Style>
                                <Style Selector="Button:pointerover /template/ ContentPresenter">
                                    <Setter Property="Background" Value="#4A5A64"/>
                                </Style>
                            </Button.Styles>
                        </Button>
                    </Grid>
                </Grid>
            </Border>            
            
            <!-- Pie Menu Popup -->
            <controls:PieMenuPopup x:Name="PieMenuPopup" 
                                   IsVisible="False"
                                   ItemSelected="PieMenu_ItemSelected"/>
            
            <!-- API Key Modal Dialog -->
            <Border x:Name="APIKeyModalOverlay"
                    IsVisible="{Binding IsApiKeyModalVisible}"
                    Background="#80000000"
                    IsHitTestVisible="{Binding IsApiKeyModalVisible}"
                    ZIndex="100">
                <Border Width="420"
                        Height="700"
                        Background="#2C3A42"
                        CornerRadius="4"
                        BorderBrush="#4A5A64"
                        BorderThickness="1"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        BoxShadow="0 4 20 0 #20000000, 0 0 0 0 #00000000">
                    <Grid>
                        <StackPanel Margin="20">
                            <TextBlock Text="API Key Settings"
                                       Foreground="White"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,15"/>
                            
                            <!-- System message placeholder -->
                            <Border IsVisible="{Binding IsSystemMessageVisible}"
                                    Padding="10"
                                    Margin="0,-10,0,10"
                                    CornerRadius="3">
                                <Border.Styles>
                                    <Style Selector="Border">
                                        <!-- Default style -->
                                        <Setter Property="Background" Value="#DFF0D8"/>
                                        <Setter Property="BorderBrush" Value="#3C763D"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                    </Style>
        
                                    <!-- Success style (already default) -->
        
                                    <!-- Warning style -->
                                    <Style Selector="Border[Tag=Warning]">
                                        <Setter Property="Background" Value="#FCF8E3"/>
                                        <Setter Property="BorderBrush" Value="#8A6D3B"/>
                                    </Style>
        
                                    <!-- Error style -->
                                    <Style Selector="Border[Tag=Error]">
                                        <Setter Property="Background" Value="#F2DEDE"/>
                                        <Setter Property="BorderBrush" Value="#A94442"/>
                                    </Style>
                                </Border.Styles>
    
                                <Border.Tag>
                                    <Binding Path="SystemMessageTypeValue" />
                                </Border.Tag>
    
                                <TextBlock Text="{Binding SystemMessageText}"
                                           TextWrapping="Wrap">
                                    <TextBlock.Styles>
                                        <Style Selector="TextBlock">
                                            <Setter Property="Foreground" Value="#3C763D"/>
                                        </Style>
                                        <Style Selector="Border[Tag=Warning] > TextBlock">
                                            <Setter Property="Foreground" Value="#8A6D3B"/>
                                        </Style>
                                        <Style Selector="Border[Tag=Error] > TextBlock">
                                            <Setter Property="Foreground" Value="#A94442"/>
                                        </Style>
                                    </TextBlock.Styles>
                                </TextBlock>
                            </Border>
                            
                            <!-- Google Maps API Heading -->
                            <TextBlock Text="Google Maps API"
                                       Foreground="White"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,10"/>
                            
                            <!-- Added informational message with tooltip -->
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Text="Required for location services"
                                           Foreground="#D0D0D0"
                                           Grid.Column="0" 
                                           VerticalAlignment="Center"/>
                                
                                <Button Grid.Column="1"
                                        Width="20" 
                                        Height="20"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="8,0,0,0"
                                        ToolTip.Tip="A Google Maps API key is required to work with location information.&#x0a;If you don't already have a Google Maps subscription. refer to the documentation on how to set one up.">
                                    <Border Width="20" 
                                            Height="20" 
                                            Background="#4A5A64" 
                                            CornerRadius="10">
                                        <TextBlock Text="?"
                                                   Foreground="White"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center"
                                                   TextAlignment="Center"/>
                                    </Border>
                                </Button>
                            </Grid>
                            
                            <!-- Google Maps API Key field (moved to top) -->
                            <TextBlock Text="Google Maps API Key" Foreground="White" Margin="0,10,0,5"/>
                            <TextBox Text="{Binding GoogleMapsApiKey}"
                                     Watermark="Enter Google Maps API key"
                                     Background="#36454F"
                                     Foreground="White"
                                     BorderBrush="#4A5A64"
                                     Margin="0,0,0,20"/>
                            
                            <!-- Horizontal separator (hr equivalent) -->
                            <Border Height="1" 
                                    Background="#4A5A64" 
                                    Margin="0,10,0,20" 
                                    HorizontalAlignment="Stretch"/>
                            
                            <!-- Ebertin Method API Heading -->
                            <TextBlock Text="Ebertin Method API"
                                       Foreground="White"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,10"/>
                            
                            <!-- Account settings content here -->
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Text="Manage your API key information"
                                           Foreground="#D0D0D0"
                                           Grid.Column="0" 
                                           VerticalAlignment="Center"/>
                                
                                <Button Grid.Column="1"
                                        Width="20" 
                                        Height="20"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="8,0,0,0"
                                        ToolTip.Tip="You can set which API you connect to. You are not limited to having to use the default API, although this can be a good choice for many.&#x0a;&#x0a;You require an API key to be registered to use the API that generates chart data.&#x0a;&#x0a;If you already have an API key, enter your user name and email address here and click the Retrieve button. Your API key will be returned automatically.&#x0a;&#x0a;If you require a new API key, enter your user name and email address and click the Create API Key button. Your email address will be verified and once that is done you will be able to retrieve your API key.">
                                    <Border Width="20" 
                                            Height="20" 
                                            Background="#4A5A64" 
                                            CornerRadius="10">
                                        <TextBlock Text="?"
                                                   Foreground="White"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center"
                                                   TextAlignment="Center"/>
                                    </Border>
                                </Button>
                            </Grid>
                            
                            <!-- API Location input field with save button -->
                            <TextBlock Text="API End Point Location" Foreground="White" Margin="0,10,0,5"/>
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <TextBox Text="{Binding ApiLocation}"
                                         Watermark="Enter API endpoint URL"
                                         Background="#36454F"
                                         Foreground="White"
                                         BorderBrush="#4A5A64"
                                         Grid.Column="0" 
                                         Margin="0,0,5,0"/>
                                         
                            
                            </Grid>
                            
                            <!-- Form fields -->
                            <TextBlock Text="Username" Foreground="White" Margin="0,10,0,5"/>
                            <TextBox Text="{Binding Username}"
                                     Watermark="Enter username"
                                     Background="#36454F"
                                     Foreground="White"
                                     BorderBrush="#4A5A64"/>
                            
                            <TextBlock Text="Email" Foreground="White" Margin="0,10,0,5"/>
                            <TextBox Text="{Binding Email}"
                                     Watermark="Enter email address"
                                     Background="#36454F"
                                     Foreground="White"
                                     BorderBrush="#4A5A64"/>
                            
                            <!-- API Key label field -->
                            <TextBlock Text="API Key" Foreground="White" Margin="0,10,0,5"/>
                            <Border Background="#36454F" 
                                    BorderBrush="#4A5A64" 
                                    BorderThickness="1" 
                                    CornerRadius="3"
                                    Padding="8,6"
                                    Margin="0,0,0,10">
                                <TextBlock Text="{Binding ApiKeyDisplay}" 
                                           Foreground="#AAD0D0D0"
                                           TextWrapping="Wrap"/>
                            </Border>
                        </StackPanel>
                        
                        <!-- Action buttons -->
                        <Grid HorizontalAlignment="Stretch"
                              VerticalAlignment="Bottom"
                              Margin="20,0,20,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Left-side buttons (Create and Retrieve) -->
                            <StackPanel Grid.Column="0"
                                        Orientation="Horizontal"
                                        Spacing="10">
                                            
                                <Button Command="{Binding CreateApiKeyCommand}"
                                        Width="36" 
                                        Height="36"
                                        Background="#3E4C54"
                                        BorderBrush="#4A5A64"
                                        Foreground="White"
                                        IsEnabled="{Binding !IsProcessing}"
                                        ToolTip.Tip="Create New API Key">
                                    <Canvas Width="28" Height="28">
                                        <!-- Plus sign icon -->
                                        <Path Data="M14,4 L14,24 M4,14 L24,14" 
                                              Stroke="White" 
                                              StrokeThickness="3" 
                                              StrokeLineCap="Round"/>
                                    </Canvas>
                                </Button>
                                                
                                <Button Command="{Binding RetrieveApiKeyCommand}"
                                        Width="36" 
                                        Height="36"
                                        Background="#3E4C54"
                                        BorderBrush="#4A5A64"
                                        Foreground="White"
                                        IsEnabled="{Binding !IsProcessing}"
                                        ToolTip.Tip="Retrieve Existing API Key">
                                    <Canvas Width="28" Height="28">
                                        <!-- Downward arrow icon -->
                                        <Path Data="M14,6 L14,20 M8,14 L14,20 L20,14" 
                                              Stroke="White" 
                                              StrokeThickness="3" 
                                              StrokeLineCap="Round"/>
                                    </Canvas>
                                </Button>
                            </StackPanel>
                            
                            <!-- Right-side buttons (Save and Close) -->
                            <StackPanel Grid.Column="2"
                                        Orientation="Horizontal"
                                        Spacing="10">
                                        
                                <Button Command="{Binding SaveConfigurationCommand}"
                                        Width="36" 
                                        Height="36"
                                        Background="#3E4C54"
                                        BorderBrush="#4A5A64"
                                        Foreground="White"
                                        ToolTip.Tip="Save API Location">
                                    <Canvas Width="28" Height="28">
                                        <!-- Save Icon (floppy disk) -->
                                        <Rectangle Canvas.Left="4" Canvas.Top="4" Width="20" Height="20" 
                                                   Stroke="White" StrokeThickness="2.3" Fill="Transparent"/>
                                        <Rectangle Canvas.Left="7" Canvas.Top="12" Width="14" Height="9" 
                                                   Stroke="White" StrokeThickness="2.3" Fill="Transparent"/>
                                        <Rectangle Canvas.Left="11" Canvas.Top="4" Width="6" Height="4" 
                                                   Stroke="White" StrokeThickness="2.3" Fill="Transparent"/>
                                    </Canvas>
                                </Button>
                                
                                <Button Command="{Binding CloseApiKeyModalCommand}"
                                        Width="36" 
                                        Height="36"
                                        Background="#3E4C54"
                                        BorderBrush="#4A5A64"
                                        Foreground="White"
                                        ToolTip.Tip="Close">
                                    <Canvas Width="28" Height="28">
                                        <!-- Close Icon (X) -->
                                        <Path Data="M7,7 L21,21 M7,21 L21,7" 
                                              Stroke="White" 
                                              StrokeThickness="2.8" 
                                              StrokeLineCap="Round"/>
                                    </Canvas>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
            </Border>
        </Grid>
    </DockPanel>
</Window>